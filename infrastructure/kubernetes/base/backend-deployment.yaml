apiVersion: apps/v1
kind: Deployment
metadata:
    name: '{{ .Values.appName }}-backend'
    namespace: '{{ .Values.namespace }}'
    labels:
        app: '{{ .Values.appName }}-backend'
        version: '{{ .Values.backend.version }}'
        tier: backend
        component: api
spec:
    replicas: '{{ .Values.backend.replicas }}'
    strategy:
        type: RollingUpdate
        rollingUpdate:
            maxSurge: 1
            maxUnavailable: 0
    selector:
        matchLabels:
            app: '{{ .Values.appName }}-backend'
    template:
        metadata:
            labels:
                app: '{{ .Values.appName }}-backend'
                version: '{{ .Values.backend.version }}'
                tier: backend
                component: api
            annotations:
                prometheus.io/scrape: 'true'
                prometheus.io/port: '8000'
                prometheus.io/path: '/metrics'
        spec:
            serviceAccountName: '{{ .Values.appName }}-backend'
            securityContext:
                runAsNonRoot: true
                runAsUser: 1000
                runAsGroup: 1000
                fsGroup: 1000
                seccompProfile:
                    type: RuntimeDefault
            containers:
                - name: '{{ .Values.appName }}-backend'
                  image: '{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag }}'
                  imagePullPolicy: '{{ .Values.backend.image.pullPolicy }}'
                  ports:
                      - containerPort: '{{ .Values.backend.containerPort }}'
                        name: http
                        protocol: TCP
                      - containerPort: 8080
                        name: metrics
                        protocol: TCP
                  env:
                      - name: DATABASE_URL
                        valueFrom:
                            secretKeyRef:
                                name: '{{ .Values.appName }}-secrets'
                                key: database-url
                      - name: JWT_SECRET
                        valueFrom:
                            secretKeyRef:
                                name: '{{ .Values.appName }}-secrets'
                                key: jwt-secret
                      - name: ENCRYPTION_KEY
                        valueFrom:
                            secretKeyRef:
                                name: '{{ .Values.appName }}-secrets'
                                key: encryption-key
                      - name: LOG_LEVEL
                        valueFrom:
                            configMapKeyRef:
                                name: '{{ .Values.appName }}-config'
                                key: LOG_LEVEL
                      - name: API_URL
                        valueFrom:
                            configMapKeyRef:
                                name: '{{ .Values.appName }}-config'
                                key: API_URL
                      - name: REDIS_HOST
                        valueFrom:
                            configMapKeyRef:
                                name: '{{ .Values.appName }}-config'
                                key: REDIS_HOST
                      - name: REDIS_PORT
                        valueFrom:
                            configMapKeyRef:
                                name: '{{ .Values.appName }}-config'
                                key: REDIS_PORT
                      - name: ENVIRONMENT
                        value: '{{ .Values.environment }}'
                      - name: ENABLE_AUDIT_LOGGING
                        value: 'true'
                      - name: RATE_LIMIT_ENABLED
                        value: 'true'
                      - name: CORS_ORIGINS
                        value: '{{ .Values.backend.corsOrigins }}'
                  securityContext:
                      allowPrivilegeEscalation: false
                      readOnlyRootFilesystem: true
                      runAsNonRoot: true
                      runAsUser: 1000
                      runAsGroup: 1000
                      capabilities:
                          drop:
                              - ALL
                      seccompProfile:
                          type: RuntimeDefault
                  resources:
                      requests:
                          memory: '{{ .Values.backend.resources.requests.memory }}'
                          cpu: '{{ .Values.backend.resources.requests.cpu }}'
                      limits:
                          memory: '{{ .Values.backend.resources.limits.memory }}'
                          cpu: '{{ .Values.backend.resources.limits.cpu }}'
                  livenessProbe:
                      httpGet:
                          path: /health
                          port: '{{ .Values.backend.containerPort }}'
                          scheme: HTTP
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      timeoutSeconds: 5
                      failureThreshold: 3
                  readinessProbe:
                      httpGet:
                          path: /ready
                          port: '{{ .Values.backend.containerPort }}'
                          scheme: HTTP
                      initialDelaySeconds: 5
                      periodSeconds: 5
                      timeoutSeconds: 3
                      failureThreshold: 3
                  volumeMounts:
                      - name: tmp-volume
                        mountPath: /tmp
                      - name: logs-volume
                        mountPath: /app/logs
                      - name: config-volume
                        mountPath: /app/config
                        readOnly: true
                - name: log-shipper
                  image: fluent/fluent-bit:latest
                  resources:
                      requests:
                          memory: '64Mi'
                          cpu: '50m'
                      limits:
                          memory: '128Mi'
                          cpu: '100m'
                  securityContext:
                      allowPrivilegeEscalation: false
                      readOnlyRootFilesystem: true
                      runAsNonRoot: true
                      runAsUser: 1000
                      capabilities:
                          drop:
                              - ALL
                  volumeMounts:
                      - name: logs-volume
                        mountPath: /app/logs
                        readOnly: true
                      - name: fluent-bit-config
                        mountPath: /fluent-bit/etc
                        readOnly: true
            volumes:
                - name: tmp-volume
                  emptyDir:
                      sizeLimit: 100Mi
                - name: logs-volume
                  emptyDir:
                      sizeLimit: 1Gi
                - name: config-volume
                  configMap:
                      name: '{{ .Values.appName }}-config'
                - name: fluent-bit-config
                  configMap:
                      name: fluent-bit-config
            nodeSelector:
                kubernetes.io/os: linux
            tolerations:
                - key: 'node.kubernetes.io/not-ready'
                  operator: 'Exists'
                  effect: 'NoExecute'
                  tolerationSeconds: 300
                - key: 'node.kubernetes.io/unreachable'
                  operator: 'Exists'
                  effect: 'NoExecute'
                  tolerationSeconds: 300
            affinity:
                podAntiAffinity:
                    preferredDuringSchedulingIgnoredDuringExecution:
                        - weight: 100
                          podAffinityTerm:
                              labelSelector:
                                  matchExpressions:
                                      - key: app
                                        operator: In
                                        values:
                                            - '{{ .Values.appName }}-backend'
                              topologyKey: kubernetes.io/hostname
